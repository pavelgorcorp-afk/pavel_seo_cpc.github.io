<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DMC: POC Banner Calc 2025</title>

  <!-- Yandex.Metrika counter -->
  <script type="text/javascript">
      (function(m,e,t,r,i,k,a){
          m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
          m[i].l=1*new Date();
          for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
          k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
      })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105999900', 'ym');

      ym(105999900, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/105999900" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->

  <style>
    :root {
      --char-color: #3d85c6;
      --weapon-color: #c0392b;

      --bg: #1c1c1e;
      --card-bg: #2c2c2e;
      --text: #ffffff;
      --secondary: #555557;
    }

    body {
      font-family: -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 15px;
      margin: 0;
      display: flex;
      justify-content: center;
    }
    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 400px;
    }
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      background: #3a3a3c;
      padding: 5px;
      border-radius: 10px;
    }
    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border-radius: 8px;
      font-size: 0.9rem;
      transition: 0.3s;
      color: #aaa;
      user-select: none;
    }

    .tab.active { background: var(--char-color); color: white; }
    .tab.active.weapon-tab { background: var(--weapon-color); }

    h3 {
      margin-top: 0;
      color: var(--char-color);
      text-align: center;
      font-size: 1.1rem;
    }
    .weapon-title { color: var(--weapon-color) !important; }

    label {
      display: block;
      margin: 10px 0 5px;
      font-size: 0.85rem;
      color: #aaa;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 10px;
      border: 1px solid #444;
      background: #3a3a3c;
      color: white;
      box-sizing: border-box;
      font-size: 1rem;
      outline: none;
    }
    input:focus { border-color: var(--char-color); }

    .btn-group { display: flex; gap: 10px; margin-top: 10px; }
    button {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      transition: opacity 0.2s;
    }
    .btn-calc { background: var(--char-color); color: white; flex: 2; }
    .btn-reset { background: var(--secondary); color: white; flex: 1; }
    button:active { opacity: 0.8; }

    .res {
      margin-top: 20px;
      padding: 15px;
      background: #3a3a3c;
      border-radius: 10px;
      font-size: 0.9rem;
      line-height: 1.6;
    }
    .mode-title {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      border-bottom: 1px solid #555;
      padding-bottom: 3px;
    }
    .footer {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px dashed #555;
      text-align: center;
      font-size: 0.8rem;
      color: #888;
    }
    .donate-id {
      display: inline-block;
      margin-top: 5px;
      color: #ddd;
      background: #444;
      padding: 4px 8px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="tabs">
      <div id="tabChar" class="tab active" onclick="switchTab('char')">Персонаж</div>
      <div id="tabWeapon" class="tab" onclick="switchTab('weapon')">Оружие</div>
    </div>

    <h3 id="mainTitle">Калькулятор Персонажа</h3>

    <!-- ПЕРСОНАЖ -->
    <div id="charFields">
      <label>Нужно уровней (копий):</label>
      <input type="number" id="levels" value="1" min="1" />

      <label>Текущий шаг цикла (1-5):</label>
      <select id="currentStep">
        <option value="0">1 (За 10)</option>
        <option value="1">2 (За 5)</option>
        <option value="2">3 (За 10)</option>
        <option value="3">4 (За 10)</option>
        <option value="4">5 (БЕСПЛАТНЫЙ)</option>
      </select>

      <label>Счетчик гаранта (сейчас):</label>
      <input type="number" id="charPity" value="90" min="20" max="90" />

      <label>Есть 100% гарант на персонажа?</label>
      <select id="charGuaranteed">
        <option value="no">Нет (50/50)</option>
        <option value="yes">Да (100%)</option>
      </select>
    </div>

    <!-- ОРУЖИЕ -->
    <div id="weaponFields" style="display:none;">
      <label>Нужно копий оружия:</label>
      <input type="number" id="wepCount" value="1" min="1" />

      <label>Счетчик гаранта (сейчас):</label>
      <input type="number" id="wepPity" value="90" min="20" max="90" />

      <label>Есть 100% гарант на оружие?</label>
      <select id="wepGuaranteed">
        <option value="no">Нет (50/50)</option>
        <option value="yes">Да (100%)</option>
      </select>
    </div>

    <div class="btn-group">
      <button id="calcBtn" class="btn-calc" onclick="calculate()">Рассчитать</button>
      <button class="btn-reset" onclick="resetPage()">Сброс</button>
    </div>

    <div id="result" class="res">Результаты появятся здесь...</div>

    <div class="footer">
      Благодарность автору (In-game ID):<br />
      <div class="donate-id">115290070957</div>
    </div>
  </div>

  <script>
    let currentMode = "char";

    function switchTab(mode) {
      currentMode = mode;
      const isChar = mode === "char";

      document.getElementById("tabChar").classList.toggle("active", isChar);
      document.getElementById("tabWeapon").classList.toggle("active", !isChar);
      document.getElementById("tabWeapon").classList.toggle("weapon-tab", !isChar);

      document.getElementById("charFields").style.display = isChar ? "block" : "none";
      document.getElementById("weaponFields").style.display = isChar ? "none" : "block";

      const title = document.getElementById("mainTitle");
      title.innerText = isChar ? "Калькулятор Персонажа" : "Калькулятор Оружия";
      title.className = isChar ? "" : "weapon-title";

      document.getElementById("calcBtn").style.background = isChar ? "var(--char-color)" : "var(--weapon-color)";
    }

    // Персонаж
    function calculateCharacter(count, startStep, currentPity, startGuaranteed) {
      const stepCosts = [10, 5, 10, 10, 0];
      const cyclePulls = 70;
      const pullsPerStep = 10;
      const cycleSteps = cyclePulls / pullsPerStep; // 7
      const crystalRate = 180;

      count = Math.max(0, parseInt(count) || 0);
      startStep = ((parseInt(startStep) || 0) % 5 + 5) % 5;
      currentPity = Math.min(90, Math.max(20, parseInt(currentPity) || 90));
      startGuaranteed = !!startGuaranteed;

      const firstLegendPulls = Math.max(0, currentPity - 20);
      const firstLegendSteps = Math.ceil(firstLegendPulls / pullsPerStep);

      function simulateByTotalLegendaries(totalLegendaries) {
        if (count === 0 || totalLegendaries === 0) {
          return { cards: 0, crystals: 0, steps: 0, legendaries: 0 };
        }

        const totalSteps = firstLegendSteps + (totalLegendaries - 1) * cycleSteps;

        let stepIdx = startStep;
        let totalCards = 0;

        for (let i = 0; i < totalSteps; i++) {
          totalCards += stepCosts[stepIdx % 5];
          stepIdx++;
        }

        return {
          cards: totalCards,
          crystals: totalCards * crystalRate,
          steps: totalSteps,
          legendaries: totalLegendaries
        };
      }

      const luckyLeg = count;
      const mixedLeg = startGuaranteed ? (2 * count - 1) : (2 * count);

      // ✅ FIX #1: Худший случай учитывает стартовый 100% гарант
      const worstLeg = startGuaranteed ? (2 * count - 1) : (2 * count);

      return {
        lucky: simulateByTotalLegendaries(luckyLeg),
        mixed: simulateByTotalLegendaries(mixedLeg),
        worst: simulateByTotalLegendaries(worstLeg)
      };
    }

    // Оружие (1 pull = 1 card)
    function calculateWeapon(count, currentPity, startGuaranteed) {
      const cyclePulls = 70;
      const crystalRate = 180;

      count = Math.max(0, parseInt(count) || 0);
      currentPity = Math.min(90, Math.max(20, parseInt(currentPity) || 90));
      startGuaranteed = !!startGuaranteed;

      const firstLegendPulls = Math.max(0, currentPity - 20);

      function simulateByTotalLegendaries(totalLegendaries) {
        if (count === 0 || totalLegendaries === 0) {
          return { cards: 0, crystals: 0, pulls: 0, legendaries: 0 };
        }

        const totalPulls = firstLegendPulls + (totalLegendaries - 1) * cyclePulls;

        return {
          cards: totalPulls,
          pulls: totalPulls,
          crystals: totalPulls * crystalRate,
          legendaries: totalLegendaries
        };
      }

      const luckyLeg = count;

      // ✅ FIX #2: "Обычная" теперь не равна "Худшему" (мат. ожидание 50/50)
      // - без гаранта: 1.5 леги на копию
      // - с гарантом: 1 лега на 1-ю копию, дальше по 1.5 => 1.5*count - 0.5
      const mixedLeg = startGuaranteed ? (1.5 * count - 0.5) : (1.5 * count);

      // Худший случай также учитывает стартовый гарант
      const worstLeg = startGuaranteed ? (2 * count - 1) : (2 * count);

      return {
        lucky: simulateByTotalLegendaries(luckyLeg),
        mixed: simulateByTotalLegendaries(mixedLeg),
        worst: simulateByTotalLegendaries(worstLeg)
      };
    }

    function calculate() {
      let out = "";

      if (currentMode === "char") {
        const count = parseInt(document.getElementById("levels").value) || 0;
        const startStep = parseInt(document.getElementById("currentStep").value);
        const currentPity = parseInt(document.getElementById("charPity").value) || 90;
        const startGuar = document.getElementById("charGuaranteed").value === "yes";

        const res = calculateCharacter(count, startStep, currentPity, startGuar);

        out += `<span class="mode-title" style="color:var(--char-color)">● Супер удача (всегда на 70)</span>`;
        out += `Карт: <b>${res.lucky.cards}</b> | Кристаллов: <b>${res.lucky.crystals.toLocaleString()}</b><br>`;

        out += `<span class="mode-title" style="color:var(--char-color)">● Обычная (среднее 50/50)</span>`;
        out += `Карт: <b>${res.mixed.cards}</b> | Кристаллов: <b>${res.mixed.crystals.toLocaleString()}</b><br>`;

        out += `<span class="mode-title" style="color:var(--char-color)">● Худший случай (по 140)</span>`;
        out += `Карт: <b>${res.worst.cards}</b> | Кристаллов: <b>${res.worst.crystals.toLocaleString()}</b><br>`;

      } else {
        const count = parseInt(document.getElementById("wepCount").value) || 0;
        const currentPity = parseInt(document.getElementById("wepPity").value) || 90;
        const startG = document.getElementById("wepGuaranteed").value === "yes";

        const res = calculateWeapon(count, currentPity, startG);

        out += `<span class="mode-title" style="color:var(--weapon-color)">● Супер удача (70 на копию)</span>`;
        out += `Карт: <b>${res.lucky.cards}</b> | Кристаллов: <b>${res.lucky.crystals.toLocaleString()}</b><br>`;

        out += `<span class="mode-title" style="color:var(--weapon-color)">● Обычная (шанс 50/50)</span>`;
        out += `Карт: <b>${res.mixed.cards}</b> | Кристаллов: <b>${res.mixed.crystals.toLocaleString()}</b><br>`;

        out += `<span class="mode-title" style="color:var(--weapon-color)">● Худший случай (по 140)</span>`;
        out += `Карт: <b>${res.worst.cards}</b> | Кристаллов: <b>${res.worst.crystals.toLocaleString()}</b><br>`;
      }

      document.getElementById("result").innerHTML = out;
    }

    function resetPage() {
      if (currentMode === "char") {
        document.getElementById("levels").value = 1;
        document.getElementById("currentStep").value = 0;
        document.getElementById("charPity").value = 90;
        document.getElementById("charGuaranteed").value = "no";
      } else {
        document.getElementById("wepCount").value = 1;
        document.getElementById("wepPity").value = 90;
        document.getElementById("wepGuaranteed").value = "no";
      }

      document.getElementById("result").innerHTML = "Результаты появятся здесь...";
      switchTab(currentMode);
    }

    switchTab(currentMode);
  </script>
</body>
</html>
